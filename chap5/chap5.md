# 5章 メモリ管理

Linuxは、システムに搭載されるメモリをカーネルのメモリ管理システムにより管理する。

## 統計情報

`free`コマンドによりメモリの統計情報を確認できる。

```
$ free
              total        used        free      shared  buff/cache   available
Mem:        8068456     2340640     4030844      315076     1696972     5178248
Swap:       2097148           0     2097148
```

- `total`: システムに搭載される全メモリ量
- `free`: 見かけ上の空きメモリ
- `buff/cache`: バッファキャッシュ、ページキャッシュが使用するメモリ。システムの空きメモリが減少してきた際に開放される
- `available`: 実質的な空きメモリ。freeフィールドのメモリ量+開放できるカーネル内メモリ領域のサイズ

`sar -r [sec]` で確認できるリアルタイム統計情報と一部対応している。

- `free` - `kbmemfree`
- `buff/cache`- `kbbuffers` + `kbcached`

```
$ sar -r 1
...

23時55分16秒 kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
23時55分17秒   3998384   5148496   4070072     50.44     93112   1529620   8040504     79.10   2581208   1147640       172
23時55分18秒   3997920   5148032   4070536     50.45     93112   1530024   8040504     79.10   2581264   1148044       172
23時55分19秒   3997796   5147908   4070660     50.45     93112   1530116   8040504     79.10   2581340   1148152       172
23時55分20秒   3997300   5147416   4071156     50.46     93120   1530528   8040504     79.10   2581404   1148564       196
...
```

## Out Of Memory

メモリ使用量の増加に伴ってメモリ管理システムはカーネル内の開放可能なメモリ領域を開放するが、領域を使い果たすとOut Of Memory (OOM) 状態となる。

この場合カーネルはOOM killer機能により、適当なプロセスを強制終了 (kill) しメモリ領域を開放することでシステムの停止を防ぐ。

設定により、プロセスに対するOOM Killerの優先度を低くする、あるいは対象から外すことができる。

## メモリ割り当て

プロセスに対するカーネルのメモリ割り当ては大まかに次のタイミングとなる（仮想記憶を想定しない単純な条件下）。

- プロセス生成時のメモリ割り当て: 実行ファイルの解析とメモリマップの作成、領域の割り当て

- プロセス生成後の動的メモリ割り当て: メモリ割り当て要求のシステムコールを発行、空き領域からの確保

この方法には次のような問題が生じる。

- メモリの断片化（フラグメンテーション）

    メモリの獲得・開放を繰り返すことで使用領域が細分化され、大きな連続領域を確保できなくなる。一つのプロセスで複数領域を管理するのは困難

- 別用途へのメモリアクセスが可能

    アドレスを指定すればカーネルや他のプロセスの使用する領域にアクセスでき、データの破壊・漏洩のリスクがある

- マルチプロセスが困難

    メモリマップが重複するため、同一のプログラムを複数起動することができない

## 仮想記憶

システムに搭載された物理メモリに対し、実際のメモリアドレス（物理アドレス）とは別の仮想的なアドレス（仮想アドレス、論理アドレス）を割り当てて管理する手法。

### ページテーブル

物理-仮想アドレスへの対応付には、ページテーブルが利用される。

- 仮想アドレス空間はページ単位（x86_64アーキテクチャでは4KiB）に分割される
    - 同様の物理アドレス空間の分割をフレームと呼ぶ

- ページテーブルエントリ: 1つのページに対するアドレスの対応づけのデータ

- 物理アドレスが対応していない仮想アドレスを参照すると、ページフォールトというプロセッサ割り込みが発生する
    - 割り込みハンドラ（ページフォールトハンドラ）の処理はOS側が提供する。セグメンテーション違反を示すSIGSEGVシグナルの通知など

